parameters:
  layoutRoot: ''
  taskFolder: ''

steps:
# Guard against missing parameters
- ${{ if eq(parameters.layoutRoot, '') }}:
  - |
      Badly configured build; an expected parameter is missing. //
      layoutRoot: ${{ parameters.layoutRoot }}
- script: mkdir ${{ parameters.layoutRoot }}\_signedTasks
  displayName: Create _signedTasks folder

# TODO loop over all tasks if taskFolder is not set
- script: echo ^<?xml version="1.0" encoding="utf-8"?^>^<package xmlns="http://schemas.microsoft.com/packaging/2010/07/nuspec.xsd"^>^<metadata^>^<id^>CmdLineV2^</id^>^<version^>0.0.0^</version^>^<authors^>Microsoft^</authors^>^<copyright^>Â© Microsoft Corporation. All rights reserved.^</copyright^>^</metadata^>^</package^> > ${{ parameters.layoutRoot }}\Tasks\${{ parameters.taskFolder }}\task.nuspec
  displayName: Create ${{ parameters.taskFolder }}\task.nuspec
- task: ArchiveFiles@2
  inputs:
     rootFolderOrFile: '${{ parameters.layoutRoot }}\Tasks\${{ parameters.taskFolder }}'
     includeRootFolder: false
     archiveType: zip
     archiveFile: '${{ parameters.layoutRoot }}\_signedTasks\${{ parameters.taskFolder }}.nupkg'
     replaceExistingArchive: true
  displayName: Create zip file _signedTasks\${{ parameters.taskFolder }}.nupkg
# END LOOP
- script: dir ${{ parameters.layoutRoot }}\_signedTasks
  displayName: dir _signedTasks (before)

- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@1
  inputs:
    ConnectedServiceName: AzurePipelinesTasksESRP
    FolderPath: '${{ parameters.layoutRoot }}\_signedTasks'
    Pattern: '*.nupkg'
    signConfigType: inlineSignParams
    inlineOperation: |
      [{
      "keyCode": "CP-401405",
      "operationSetCode": "NuGetSign",
      "parameters": [],
      "toolName": "sign",
      "toolVersion": "1.0"
      },
      {
      "keyCode": "CP-401405",
      "operationSetCode": "NuGetVerify",
      "parameters": [],
      "toolName": "sign",
      "toolVersion": "1.0"
      }
      ]
  displayName: Sign Task Nuget Packages

- script: dir ${{ parameters.layoutRoot }}\_signedTasks
  displayName: dir _signedTasks (after)